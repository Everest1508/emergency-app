<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Driver Tracker</title>

    <link rel="icon" href="https://api.iconify.design/mdi:car.svg?color=purple" type="image/svg+xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-charts/dist/frappe-charts.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">
    {% include 'components/sidebar.html' %}
    
    <div id="map" class="w-full h-screen z-10"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const drivers = JSON.parse('{{ drivers_json|escapejs }}');
            const adminUsername = "{{ request.user.username }}";
            const token = "{{ token.key }}";
            const markers = {};
    
            const map = L.map('map').setView([19.988480, 73.770598], 11);
    
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
            }).addTo(map);
    
            // Initial static markers
            drivers.forEach(driver => {
                const marker = L.marker([driver.lat, driver.lng]).addTo(map);
                marker.bindPopup(`
                    <div style="min-width: 150px">
                        <strong>${driver.username}</strong><br />
                        Status: <span style="color:${driver.status === 'online' ? 'green' : 'red'}">${driver.status}</span><br />
                        Duty: ${driver.dutyStatus}
                    </div>
                `);
                markers[driver.username] = marker;
            });
    
            console.log("Markers after initial placement:", markers);  // Log the markers object
            console.log("Initial markers (by username):", Object.keys(markers));  // Log the keys
    
            // Determine the protocol dynamically based on the current page's protocol
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';

            // WebSocket connection using the appropriate protocol (wss for HTTPS, ws for HTTP)
            const socket = new WebSocket(`${protocol}://${window.location.host}/ws/user/${adminUsername}/?token=${token}`);

            socket.onopen = () => {
                console.log("WebSocket connected.");
            };
    
            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);

                // ‚úÖ Log the complete data payload received
                console.log("üîÑ Full WebSocket data received:", data);

                if (data.type === "admin_driver_location_update") {
                    const { latitude, longitude, driver: incomingDriver } = data;
                    console.log("üìç Location update ‚Üí Driver:", incomingDriver, "| Lat:", latitude, "| Lng:", longitude);

                    // Check if the incoming driver already exists in markers
                    if (markers.hasOwnProperty(incomingDriver)) {
                        console.log("‚úÖ Existing marker found for:", incomingDriver);
                        markers[incomingDriver].setLatLng([latitude, longitude]);
                    } else {
                        console.warn("‚ö†Ô∏è No existing marker for:", incomingDriver, "‚Üí Creating new one.");
                        const newMarker = L.marker([latitude, longitude]).addTo(map);
                        newMarker.bindPopup(`<strong>${incomingDriver}</strong><br />Live Update`);
                        markers[incomingDriver] = newMarker;
                    }

                    // Log markers after update
                    console.log("Markers (after WebSocket update):", markers);
                    console.log("Updated markers keys:", Object.keys(markers));
                }
            };
    
            socket.onclose = () => {
                console.log("WebSocket disconnected.");
            };
        });
    </script>
    
</body>
</html>
